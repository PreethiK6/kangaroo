---
title: "Project 1"
author: "SDS348 Fall 2019"
date: "October 15, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}

trump_og <- read.csv("C:/Users/Preet/Desktop/SDS 348/SDS 348 HW/Trump Approval.csv")
hate_crimes <- read.csv("C:/Users/Preet/Desktop/SDS 348/SDS 348 HW/HateCrimes2.csv")
hcpluspop <- read.csv("C:/Users/Preet/Desktop/SDS 348/SDS 348 HW/SumStatsHC.csv")

library(dplyr)
library(ggplot2)
library(ggrepel)
library(tidyr)
library(tidyverse)

```

#####Introduction:
#####The two datasets I have chosen for my project contain information about Trump's approval rating for 50 U.S. states during 2017 and hate crimes that were committed throughout the U.S. The Trump approval dataset contains a variety of variables that give the percents of the population that approved and disapproved of Trump, as well as multiple statistics regarding party preferences of each state. This dataset was acquired from Gallup Polls. The hate crimes dataset records every incident that was reported to the police in each state from 1991 to 2017. It also contains variables that describe region, bias description, offender description, etc.; I got this dataset from the FBI Crime Data Explorer website.I'm interested in these datasets because of the current volatile political climate. Also becasue it feels like since Trump's presidency, there has been an increase in intolerance toward different cultures and people. Some potential associations I would expect to find are states with higher Trump approval have higher incidences of hate crimes per capita. I also expect to find states that are more conservative to have higher crimes per capita.

```{r}
#Both my datasets are already tidy so I'm making one of them longer first by putting all the different variables into one column and then I'm re-tidying the data by separating each variable into their own column by pivoting wider to show my use of the tidyr functions

trump_og %>% mutate(Total_Pop=gsub(pattern = ",","",Total_Pop), Total_Pop=as.numeric(Total_Pop), Total_Pop=as.integer(Total_Pop)) -> trump_og

trump_og %>% pivot_longer(3:12, names_to = "variable", values_to= "percents") -> trump_long
head(trump_long)

trump_long %>% pivot_wider(names_from = "variable", values_from = "percents") -> trump_wide
head(trump_wide)

```

```{r}
#Created a new column that assigns each state a party preference based on majority party percentage.

trump_app <- trump_og %>% mutate(
  Party_Maj = case_when(
    Conservative > Moderate & Conservative > Liberal ~ "conservative",
    Moderate > Conservative & Moderate > Liberal ~ "moderate",
    Liberal > Conservative & Liberal > Moderate ~ "liberal",
    Repub_Lean > Demo_Lean ~ "conservative",
    Demo_Lean > Repub_Lean ~ "liberal"
  )
)

head(trump_app)

```

```{r}
#This is the originial dataset with statistics from 1991 to 2017.
head(hate_crimes)

#This dataset contains the total number of hate crimes committed per state in the year 2017, and will be merged with the trump approval dataset.

hate_crimes %>% select(DATA_YEAR, STATE_ABBR, STATE_NAME, OFFENDER_RACE, BIAS_DESC) %>% filter(DATA_YEAR == '2017') %>% group_by(STATE_NAME) %>% summarise(total_crimes = n()) %>% arrange(desc(total_crimes)) -> total_hc
head(total_hc)


#The dataset below includes the total hate crimes in committed in each state plus the other variables.

hate_crimes %>% select(DATA_YEAR, STATE_ABBR, STATE_NAME, OFFENDER_RACE, BIAS_DESC) %>% filter(DATA_YEAR == '2017') %>% group_by(STATE_NAME) %>% mutate(total_crimes = n()) %>% arrange(desc(total_crimes)) -> hate_crimes2
head(hate_crimes2)


```


```{r}

#This gives the proportion of the bias of hate crime committed in relation to the total hate crimes per state.

hate_crimes %>% filter(DATA_YEAR == '2017') %>% group_by(STATE_NAME,BIAS_DESC) %>% summarize(n=n())%>%mutate(prop=n/sum(n))%>% pivot_wider(-n,names_from = BIAS_DESC, values_from = prop) -> prop_bias

head(prop_bias)
glimpse(prop_bias)

```

```{r}

#Creating summary statistics for hate crimes by region, offender race, bias description, and offense name.

hcpluspop %>% mutate(TOT_POP=gsub(pattern = ",","",TOT_POP), TOT_POP=as.numeric(TOT_POP), TOT_POP=as.integer(TOT_POP)) -> hcpluspop

hcpluspop %>% select(STATE_NAME, OFFENDER_RACE, BIAS_DESC, REGION_NAME, OFFENSE_NAME, TOT_POP)%>% group_by(BIAS_DESC) %>% summarize(n=n())%>%mutate(prop_tc_bias=n/sum(n))

hcpluspop %>% select(STATE_NAME, OFFENDER_RACE, BIAS_DESC, REGION_NAME, OFFENSE_NAME, TOT_POP)%>% group_by(OFFENSE_NAME) %>% summarize(n=n())%>%mutate(prop_tc_off_name=n/sum(n))

hcpluspop %>% select(STATE_NAME, OFFENDER_RACE, BIAS_DESC, REGION_NAME, OFFENSE_NAME, TOT_POP)%>% group_by(OFFENDER_RACE) %>% summarize(n=n())%>%mutate(prop_tc_off_race=n/sum(n))


hcpluspop %>% select(STATE_NAME, OFFENDER_RACE, BIAS_DESC, REGION_NAME, OFFENSE_NAME, TOT_POP)%>% group_by(REGION_NAME)%>% summarize(n=n())%>%mutate(prop_tc_reg=n/sum(n))

```

```{r}

#I'm using inner_join() because I want to keep all the rows that have a match in both datasets. The District of Columbia was included in the hate crimes dataset, but not the trump approval dataset, so I got rid of the row that included it. The only problem with this is that District of Columbia will not be included for analysis. 

inner_join(trump_app,total_hc, by = "STATE_NAME") -> no_bias_prop

head(no_bias_prop)


```

```{r}

#I'm using inner_join() on both no_bias_prop and prop_bias so that I can keep all the matching rows and variables from both datasets and drop the District of Columbia row.

inner_join(no_bias_prop, prop_bias, by = "STATE_NAME") -> comb_data2

head(comb_data2)

```


```{r}

#Creating the hate crime per capita variable column

comb_data2 %>% mutate(hc_per_capita= total_crimes/Total_Pop) -> comb_data

head(comb_data)

```

#####My first plot is a scatterplot between trump approval rating and total hates crimes per capita between the 50 states in the combined dataset. There isn't a clear association between Trump approval and hate crimes as I had expected. It seems that the number of hate crimes committed per capita for each state seem to stay around the same value regardless of the states approval rating for Trump. There are a couple outliers one being Kentucky, which has the largest per capita hate crimes committed as well as a fairly high Trump approval rate. It would be interesting to compare the increase/decrease of hates crimes during Obama's presidential term compared to Trump's. 

```{r}

ggplot(data = comb_data, aes(x = Trump_Approval, y = hc_per_capita)) + geom_point() + scale_x_continuous(breaks = seq(0,80,by = 5)) + ggtitle("Trump Approval and Hate Crimes Per Capita in 2017") + geom_text_repel(aes(x=Trump_Approval,y=hc_per_capita,label=STATE_ABBR), size = 3) + labs(y="Hate Crimes per Capita", x = "Trump Approval (%)") + theme(legend.position = "none") 


```

#####My second plot is a barplot that shows the mean hate crime per capita committed within each political party group. The moderate party group means that the members of the group are more centrist than liberal or conservative. The bar plot shows that more hate crimes were committed in states that are liberal or moderate than conservative, which is not what I expected. But it makes sense because a lot of the more populous big city states like California and New York, which are more liberal, have more crime. Overall, you can't draw any significant evidence from the bar plot because the standard error bars overlap.
```{r}

ggplot(comb_data, aes(x=Party_Maj,y=hc_per_capita,fill=Party_Maj))+ scale_fill_brewer(palette = "Dark2") + geom_bar(stat = "summary")+ geom_errorbar(stat = "summary",width=.2) + theme(legend.position = "none") + ggtitle("Hate Crimes in Relation to Party Preference") + labs(y="Hate Crimes per Capita", x = "Political Parties")

```

#####There is a strong positive correlation between Trump approval and Republican lean as well as being conservative. There is a strong positive correlation between Trump disapproval and Democratic lean as well as being liberal.
```{r}

comb_data %>% select(-c(STATE_ABBR, STATE_NAME, 12:26)) %>% cor() 

```

#####We see that PC1 alone explains 82.66% of the variance and having both PC1 and PC2 explains 94.69% of the variance.
```{r}

comb_data %>% select(-c(STATE_ABBR, STATE_NAME, 12:26))%>% scale() %>% prcomp() -> comb_pca

comb_pca

summary(comb_pca)



```

```{r}

comb_data %>% select(-c(STATE_ABBR, STATE_NAME, 12:26)) %>% cor() %>% eigen()



```

#####According to the plot PC1 does a good job explaining all the other variables except for Moderate, which is explained by PC2. The arrows with the smaller angles between them are more higly correlated like being liberal and Trump disapproval, which was mentioned earlier. 
```{r}

comb_pca$rotation[,1:2]%>%as.data.frame%>%rownames_to_column%>%ggplot()+geom_hline(aes(yintercept=0),lty=2)+ geom_vline(aes(xintercept=0),lty=2)+ylab("PC2")+xlab("PC1")+
geom_segment(aes(x=0,y=0,xend=PC1,yend=PC2),arrow=arrow(),col="red")+
geom_label(aes(x=PC1*1.1,y=PC2*1.1,label=rowname))






```

```{r}

data(comb_data)
comb_data<-comb_data 


comb_pca$x%>%as.data.frame%>%mutate(State=comb_data$STATE_NAME)%>%ggplot(aes(PC1,PC2))+geom_point()



```



```{r}





```


